#!/usr/bin/env zsh
set -euo pipefail

# OSガード: Linux/macOSのみ実行
if [[ "{{ .chezmoi.os }}" != "linux" && "{{ .chezmoi.os }}" != "darwin" ]]; then
  exit 0
fi

# sudoがあれば使う
if command -v sudo >/dev/null 2>&1; then
  SUDO="sudo"
else
  SUDO=""
fi

if [[ "{{ .chezmoi.os }}" == "linux" ]]; then
  # aptがあるか確認
  if ! command -v apt >/dev/null 2>&1; then
    echo "apt not found; skipping package install." >&2
    exit 0
  fi

  $SUDO apt update
  $SUDO apt upgrade -y

  # apt用パッケージ一覧 (Debian/Ubuntu)
  packages=(
    bat
    build-essential
    fd-find
    fzf
    gh
    ghq
    ghostty
    git
    git-delta
    helix
    lazygit
    lsd
    neovim
    peco
    ripgrep
    unzip
    yazi
    zellij
  )

  # 未インストールのみ入れる
  for pkg in "${packages[@]}"; do
    if dpkg -s "$pkg" >/dev/null 2>&1; then
      continue
    fi

    if ! $SUDO apt install -y "$pkg"; then
      echo "apt install failed for $pkg. Trying snap..."
      if command -v snap >/dev/null 2>&1; then
        $SUDO snap install "$pkg" --classic || echo "snap install failed for $pkg"
      else
        echo "snap not found or failed. Skipping $pkg."
      fi
    fi
  done

  # NeovimはAppImageで最新版を取得
  curl -LO https://github.com/neovim/neovim/releases/latest/download/nvim-linux-x86_64.appimage
  chmod u+x nvim-linux-x86_64.appimage
  ./nvim-linux-x86_64.appimage
  $SUDO mkdir -p /opt/nvim
  $SUDO mv nvim-linux-x86_64.appimage /opt/nvim/nvim

elif [[ "{{ .chezmoi.os }}" == "darwin" ]]; then
  # Homebrewがあるか確認
  if ! command -v brew >/dev/null 2>&1; then
    echo "brew not found; skipping package install." >&2
    exit 0
  fi

  brew update
  brew upgrade

  # Homebrew用パッケージ一覧
  packages=(
    bat
    fd
    fzf
    gh
    ghq
    ghostty
    git
    git-delta
    helix
    lazygit
    lsd
    neovim
    peco
    ripgrep
    unzip
    yazi
    zellij
  )

  # 未インストールのみ入れる
  for pkg in "${packages[@]}"; do
    if brew list --formula "$pkg" >/dev/null 2>&1 || brew list --cask "$pkg" >/dev/null 2>&1; then
      continue
    fi
    
    if ! brew install "$pkg"; then
      echo "Formula install failed for $pkg. Trying with --cask..."
      brew install --cask "$pkg" || echo "Cask install also failed for $pkg"
    fi
  done
fi

# miseインストール (未インストール時のみ)
if ! command -v mise >/dev/null 2>&1; then
  echo "Installing mise..."
  curl https://mise.run | sh
fi

# oh-my-zshインストール (未インストール時のみ)
if [[ ! -d "$HOME/.oh-my-zsh" ]]; then
  echo "Installing oh-my-zsh..."
  sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)"
fi

# git-worktree-runnerインストール (未インストール時のみ)
if ! command -v git-gtr >/dev/null 2>&1; then
  echo "Installing git-worktree-runner..."
  GTR_DIR="$HOME/.local/share/git-worktree-runner"
  
  # まだクローンされていない場合のみクローン
  if [[ ! -d "$GTR_DIR" ]]; then
    git clone https://github.com/coderabbitai/git-worktree-runner.git "$GTR_DIR"
  fi
  
  # シンボリックリンク作成（既存の場合は上書き）
  $SUDO ln -sf "$GTR_DIR/bin/git-gtr" /usr/local/bin/git-gtr
fi
